---
import PeriodicTableHint from '../features/periodic-table/PeriodicTableHint';
import SolubilityHint from '../features/reactions/SolubilityHint';
import LanguageSwitcher from './LanguageSwitcher.astro';
import * as m from '../paraglide/messages.js';
import type { SupportedLocale } from '../types/i18n';
import { localizeUrl } from '../lib/i18n';

interface Props {
  locale?: SupportedLocale;
}

const locale = Astro.props.locale ?? (Astro.currentLocale as SupportedLocale) ?? 'ru';
const currentPath = Astro.url.pathname;

const groups = [
  {
    label: m.nav_group_learning(),
    links: [
      { href: localizeUrl('/diagnostics/', locale), label: m.nav_diagnostics() },
      { href: localizeUrl('/exam/', locale), label: m.nav_exam() },
      { href: localizeUrl('/calculations/', locale), label: m.nav_calculations() },
      { href: localizeUrl('/profile/', locale), label: m.nav_profile() },
    ],
  },
  {
    label: m.nav_group_chemistry(),
    links: [
      { href: localizeUrl('/periodic-table/', locale), label: m.nav_elements() },
      { href: localizeUrl('/substances/', locale), label: m.nav_substances() },
      { href: localizeUrl('/bonds/', locale), label: m.nav_bonds() },
      { href: localizeUrl('/oxidation-states/', locale), label: m.nav_oxidation_states() },
      { href: localizeUrl('/reactions/', locale), label: m.nav_reactions() },
      { href: localizeUrl('/ions/', locale), label: m.nav_ions() },
    ],
  },
];

function isActive(href: string): boolean {
  if (href === '/' || href === '/en/' || href === '/pl/' || href === '/es/') return currentPath === href;
  return currentPath.startsWith(href);
}

function isGroupActive(links: { href: string }[]): boolean {
  return links.some(link => isActive(link.href));
}

const searchUrl = localizeUrl('/search/', locale);
const homeUrl = localizeUrl('/', locale);
---

<nav class="nav">
  <div class="nav-inner container">
    <a href={homeUrl} class="nav-home" aria-label={m.nav_home()}>
      <svg width="22" height="22" viewBox="0 0 128 128" fill="none" aria-hidden="true">
        <rect x="50" y="24" width="28" height="24" rx="2" fill="var(--color-bg-alt)" stroke="var(--color-primary)" stroke-width="4"/>
        <line x1="47" y1="24" x2="81" y2="24" stroke="var(--color-primary)" stroke-width="5" stroke-linecap="round"/>
        <path d="M50 46 L22 102 Q18 112 30 118 L98 118 Q110 112 106 102 L78 46 Z" fill="var(--color-bg-alt)" stroke="var(--color-primary)" stroke-width="4"/>
        <rect x="10" y="78" width="118" height="60" fill="var(--color-primary)" opacity="0.25" clip-path="url(#fc)"/>
        <defs><clipPath id="fc"><path d="M52 48 L26 100 Q22 110 32 116 L96 116 Q106 110 102 100 L76 48 Z"/></clipPath></defs>
      </svg>
    </a>

    <input type="checkbox" id="nav-toggle" class="nav-toggle-input" />
    <label for="nav-toggle" class="nav-toggle" aria-label={m.nav_menu_label()}>
      <span></span><span></span><span></span>
    </label>

    <div class="nav-menu">
      {groups.map((group, i) => (
        <div class:list={['nav-group', { active: isGroupActive(group.links) }]} data-index={i}>
          <button class="nav-group-btn" type="button" aria-expanded="false">
            {group.label}
            <svg class="nav-chevron" width="10" height="6" viewBox="0 0 10 6" aria-hidden="true">
              <path d="M1 1l4 4 4-4" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <ul class="nav-group-items">
            {group.links.map(link => (
              <li>
                <a href={link.href} class:list={['nav-link', { active: isActive(link.href) }]}>
                  {link.label}
                </a>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </div>

    <div class="nav-actions">
      <PeriodicTableHint locale={locale} client:idle />
      <SolubilityHint locale={locale} client:idle />
      <a href={searchUrl} class="search-trigger" aria-label={m.nav_search()}>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
      </a>
      <LanguageSwitcher locale={locale} />
    </div>
  </div>
</nav>

<script>
  document.addEventListener('astro:page-load', () => {
    const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

    const navGroups = document.querySelectorAll('.nav-group');
    const navToggle = document.getElementById('nav-toggle') as HTMLInputElement | null;

    // On mobile, open first group by default when hamburger is opened
    if (isMobile() && navGroups.length > 0) {
      navGroups[0].classList.add('open');
      const btn = navGroups[0].querySelector('.nav-group-btn');
      if (btn) btn.setAttribute('aria-expanded', 'true');
    }

    navGroups.forEach(group => {
      const btn = group.querySelector('.nav-group-btn');
      if (!btn) return;

      btn.addEventListener('click', (e) => {
        e.stopPropagation();

        if (isMobile()) {
          // Accordion: toggle this group
          const isOpen = group.classList.contains('open');
          group.classList.toggle('open');
          btn.setAttribute('aria-expanded', String(!isOpen));
        } else {
          // Desktop: toggle dropdown, close others
          const isOpen = group.classList.contains('open');
          navGroups.forEach(g => {
            g.classList.remove('open');
            g.querySelector('.nav-group-btn')?.setAttribute('aria-expanded', 'false');
          });
          if (!isOpen) {
            group.classList.add('open');
            btn.setAttribute('aria-expanded', 'true');
          }
        }
      });
    });

    // Close desktop dropdowns on outside click
    document.addEventListener('click', () => {
      if (isMobile()) return;
      navGroups.forEach(g => {
        g.classList.remove('open');
        g.querySelector('.nav-group-btn')?.setAttribute('aria-expanded', 'false');
      });
    });

    // Close mobile menu when a link is clicked
    document.querySelectorAll('.nav-group-items a').forEach(link => {
      link.addEventListener('click', () => {
        if (navToggle) navToggle.checked = false;
      });
    });
  });
</script>

<style>
  .nav {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--color-bg);
    border-bottom: 1px solid var(--color-border);
    height: var(--nav-height);
  }
  .nav-inner {
    display: flex;
    align-items: center;
    height: 100%;
    gap: var(--space-xs);
  }

  /* Home icon */
  .nav-home {
    display: flex;
    align-items: center;
    padding: var(--space-xs);
    border-radius: 0.375rem;
    color: var(--color-text);
    flex-shrink: 0;
  }
  .nav-home:hover {
    background: var(--color-bg-alt);
    text-decoration: none;
  }

  /* Hamburger */
  .nav-toggle-input { display: none; }
  .nav-toggle { display: none; }

  /* Nav menu (groups) */
  .nav-menu {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  /* Group */
  .nav-group {
    position: relative;
  }
  .nav-group-btn {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: var(--space-sm) var(--space-md);
    border: none;
    border-radius: 0.375rem;
    background: none;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
    font-family: inherit;
    white-space: nowrap;
  }
  .nav-group-btn:hover {
    background: var(--color-bg-alt);
    color: var(--color-text);
  }
  .nav-group.active > .nav-group-btn {
    color: var(--color-primary);
    font-weight: 500;
  }
  .nav-chevron {
    transition: transform 0.2s;
    flex-shrink: 0;
  }
  .nav-group.open > .nav-group-btn .nav-chevron {
    transform: rotate(180deg);
  }

  /* Dropdown */
  .nav-group-items {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    list-style: none;
    margin: 0.25rem 0 0;
    padding: var(--space-xs);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    min-width: 10rem;
    z-index: 110;
  }
  .nav-group.open > .nav-group-items,
  .nav-group:focus-within > .nav-group-items {
    display: block;
  }

  /* Links */
  .nav-link {
    display: block;
    padding: var(--space-sm) var(--space-md);
    border-radius: 0.375rem;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    transition: background 0.15s, color 0.15s;
    white-space: nowrap;
  }
  .nav-link:hover {
    background: var(--color-bg-alt);
    color: var(--color-text);
    text-decoration: none;
  }
  .nav-link.active {
    color: var(--color-primary);
    font-weight: 500;
  }

  /* Right-side actions */
  .nav-actions {
    display: flex;
    align-items: center;
    margin-left: auto;
    gap: 0;
    flex-shrink: 0;
  }
  .search-trigger {
    display: flex;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    border-radius: 0.375rem;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    transition: background 0.15s, color 0.15s;
  }
  .search-trigger:hover {
    background: var(--color-bg-alt);
    color: var(--color-text);
    text-decoration: none;
  }
  .search-trigger svg { flex-shrink: 0; }

  /* Responsive hint-button labels: full on desktop, short on mobile */
  .nav :global(.hint-label-short) { display: none; }

  /* --- Mobile --- */
  @media (max-width: 768px) {
    .nav { height: auto; min-height: var(--nav-height); }
    .nav-inner { flex-wrap: wrap; }
    .nav :global(.hint-label-full) { display: none; }
    .nav :global(.hint-label-short) { display: inline; }

    .nav-toggle {
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      padding: var(--space-sm);
    }
    .nav-toggle span {
      display: block;
      width: 20px;
      height: 2px;
      background: var(--color-text);
      transition: transform 0.2s;
    }

    /* Menu: full-width accordion */
    .nav-menu {
      display: none;
      flex-direction: column;
      width: 100%;
      padding: var(--space-sm) 0;
      gap: 0;
    }
    .nav-toggle-input:checked ~ .nav-menu {
      display: flex;
    }

    /* Group as accordion section */
    .nav-group {
      width: 100%;
    }
    .nav-group-btn {
      width: 100%;
      justify-content: space-between;
      padding: var(--space-sm) var(--space-md);
      font-weight: 500;
      color: var(--color-text);
    }

    /* Dropdown becomes inline list */
    .nav-group-items {
      display: none;
      position: static;
      border: none;
      box-shadow: none;
      padding: 0 0 var(--space-xs) var(--space-md);
      min-width: 0;
      background: none;
    }
    .nav-group.open > .nav-group-items {
      display: block;
    }
    /* Disable focus-within on mobile */
    .nav-group:focus-within > .nav-group-items {
      display: none;
    }
    .nav-group.open:focus-within > .nav-group-items {
      display: block;
    }
  }
</style>
