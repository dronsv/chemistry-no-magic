---
import PeriodicTableHint from '../features/periodic-table/PeriodicTableHint';
import SolubilityHint from '../features/reactions/SolubilityHint';
import LanguageSwitcher from './LanguageSwitcher.astro';
import * as m from '../paraglide/messages.js';
import type { SupportedLocale } from '../types/i18n';
import { localizeUrl } from '../lib/i18n';

interface Props {
  locale?: SupportedLocale;
}

const locale = Astro.props.locale ?? (Astro.currentLocale as SupportedLocale) ?? 'ru';
const currentPath = Astro.url.pathname;

const links = [
  { href: localizeUrl('/', locale), label: m.nav_home() },
  { href: localizeUrl('/diagnostics/', locale), label: m.nav_diagnostics() },
  { href: localizeUrl('/periodic-table/', locale), label: m.nav_elements() },
  { href: localizeUrl('/substances/', locale), label: m.nav_substances() },
  { href: localizeUrl('/bonds/', locale), label: m.nav_bonds() },
  { href: localizeUrl('/oxidation-states/', locale), label: m.nav_oxidation_states() },
  { href: localizeUrl('/reactions/', locale), label: m.nav_reactions() },
  { href: localizeUrl('/calculations/', locale), label: m.nav_calculations() },
  { href: localizeUrl('/exam/', locale), label: m.nav_exam() },
  { href: localizeUrl('/profile/', locale), label: m.nav_profile() },
];

function isActive(href: string): boolean {
  if (href === '/' || href === '/en/' || href === '/pl/' || href === '/es/') return currentPath === href;
  return currentPath.startsWith(href);
}

const searchUrl = localizeUrl('/search/', locale);
---

<nav class="nav">
  <div class="nav-inner container">
    <a href={localizeUrl('/', locale)} class="nav-brand">{m.site_name()}</a>
    <input type="checkbox" id="nav-toggle" class="nav-toggle-input" />
    <label for="nav-toggle" class="nav-toggle" aria-label={m.nav_menu_label()}>
      <span></span><span></span><span></span>
    </label>
    <ul class="nav-links">
      {links.map(link => (
        <li>
          <a href={link.href} class:list={['nav-link', { active: isActive(link.href) }]}>
            {link.label}
          </a>
        </li>
      ))}
    </ul>
    <PeriodicTableHint client:idle />
    <SolubilityHint client:idle />
    <a href={searchUrl} class="search-trigger" aria-label={m.nav_search()}>
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" />
      </svg>
      <span class="hint-label-full">{m.nav_search()}</span>
      <span class="hint-label-short">{m.nav_search()}</span>
    </a>
    <LanguageSwitcher locale={locale} />
  </div>
</nav>

<style>
  .nav {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--color-bg);
    border-bottom: 1px solid var(--color-border);
    height: var(--nav-height);
  }
  .nav-inner {
    display: flex;
    align-items: center;
    height: 100%;
  }
  .nav-brand {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--color-text);
    margin-right: auto;
  }
  .nav-brand:hover { text-decoration: none; }
  .nav-links {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: var(--space-xs);
  }
  .nav-link {
    display: block;
    padding: var(--space-sm) var(--space-md);
    border-radius: 0.375rem;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    transition: background 0.15s, color 0.15s;
  }
  .nav-link:hover {
    background: var(--color-bg-alt);
    color: var(--color-text);
    text-decoration: none;
  }
  .nav-link.active {
    color: var(--color-primary);
    font-weight: 500;
  }
  .search-trigger {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: var(--space-sm) var(--space-md);
    border-radius: 0.375rem;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    transition: background 0.15s, color 0.15s;
  }
  .search-trigger:hover {
    background: var(--color-bg-alt);
    color: var(--color-text);
    text-decoration: none;
  }
  .search-trigger svg { flex-shrink: 0; }

  .nav-toggle-input { display: none; }
  .nav-toggle { display: none; }

  /* Responsive hint-button labels: full on desktop, short on mobile */
  .nav :global(.hint-label-short) { display: none; }

  @media (max-width: 768px) {
    .nav { height: auto; min-height: var(--nav-height); }
    .nav-inner { flex-wrap: wrap; }
    .nav-brand { display: none; }
    .nav :global(.hint-label-full) { display: none; }
    .nav :global(.hint-label-short) { display: inline; }
    .nav-toggle {
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      padding: var(--space-sm);
    }
    .nav-toggle span {
      display: block;
      width: 20px;
      height: 2px;
      background: var(--color-text);
      transition: transform 0.2s;
    }
    .nav-links {
      display: none;
      flex-direction: column;
      width: 100%;
      padding: var(--space-sm) 0;
    }
    .nav-toggle-input:checked ~ .nav-links {
      display: flex;
    }
  }
</style>
