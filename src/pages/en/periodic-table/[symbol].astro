---
import { readFile } from 'node:fs/promises';
import { join } from 'node:path';
import BaseLayout from '../../../layouts/BaseLayout.astro';

interface ElementDiscovery {
  year?: number;
  scientist_ru?: string;
  country_ru?: string;
}

interface ElementData {
  Z: number;
  symbol: string;
  name_ru: string;
  name_en: string;
  name_latin: string;
  group: number;
  period: number;
  metal_type: string;
  element_group: string;
  atomic_mass: number;
  typical_oxidation_states: number[];
  electronegativity: number | null;
  melting_point_C?: number | null;
  boiling_point_C?: number | null;
  density_g_cm3?: number | null;
  discovery?: ElementDiscovery;
  hazards_ru?: string[];
  storage_ru?: string;
  industrial_ru?: string;
  production_ru?: string;
  abundance_ru?: string;
  fun_facts_ru?: string[];
  electron_exception?: {
    config_override: [number, string, number][];
    expected_formula: string;
    actual_formula: string;
    rule: string;
    reason_ru: string;
  };
}

interface ReactionMolecularItem {
  formula: string;
  name?: string;
  coeff: number;
}

interface ReactionData {
  reaction_id: string;
  title: string;
  equation: string;
  molecular: {
    reactants: ReactionMolecularItem[];
    products: ReactionMolecularItem[];
  };
}

interface SubstanceEntry {
  id: string;
  formula: string;
  name_ru?: string;
  class: string;
}

interface ElementGroupInfo {
  name_ru: string;
  name_singular_ru: string;
}

export async function getStaticPaths() {
  const elementsPath = join(process.cwd(), 'data-src', 'elements.json');
  const elements: ElementData[] = JSON.parse(await readFile(elementsPath, 'utf-8'));

  // Load element groups for display names
  const groupsPath = join(process.cwd(), 'data-src', 'element-groups.json');
  const groupsDict: Record<string, ElementGroupInfo> = JSON.parse(await readFile(groupsPath, 'utf-8'));

  // Load reactions for cross-referencing
  const reactionsPath = join(process.cwd(), 'data-src', 'reactions', 'reactions.json');
  let reactions: ReactionData[] = [];
  try {
    reactions = JSON.parse(await readFile(reactionsPath, 'utf-8'));
  } catch { /* optional */ }

  // Load substances index for linking
  const substancesDir = join(process.cwd(), 'data-src', 'substances');
  const { readdir } = await import('node:fs/promises');
  let substances: SubstanceEntry[] = [];
  try {
    const files = await readdir(substancesDir);
    for (const f of files) {
      if (!f.endsWith('.json')) continue;
      const data = JSON.parse(await readFile(join(substancesDir, f), 'utf-8'));
      substances.push({ id: data.id, formula: data.formula, name_ru: data.name_ru, class: data.class });
    }
  } catch { /* optional */ }

  return elements.map(el => {
    // Find reactions involving this element's symbol in reactant/product formulas
    const elementReactions = reactions.filter(r => {
      const allFormulas = [
        ...r.molecular.reactants.map(x => x.formula),
        ...r.molecular.products.map(x => x.formula),
      ];
      // Check if any formula contains this element's symbol
      // Use a regex that matches the symbol followed by a digit, subscript, or end/uppercase
      const re = new RegExp(`(^|[a-z\\d₂₃₄₅₆₇₈₉)])${el.symbol}([A-Z₂₃₄₅₆₇₈₉\\d(]|$)`);
      const reStart = new RegExp(`^${el.symbol}([A-Z₂₃₄₅₆₇₈₉\\d(]|$)`);
      return allFormulas.some(f => reStart.test(f) || re.test(f));
    });

    // Find related substances (those containing this element)
    const relatedSubstances = substances.filter(s => {
      const re = new RegExp(`(^|[a-z\\d₂₃₄₅₆₇₈₉)])${el.symbol}([A-Z₂₃₄₅₆₇₈₉\\d(]|$)`);
      const reStart = new RegExp(`^${el.symbol}([A-Z₂₃₄₅₆₇₈₉\\d(]|$)`);
      return reStart.test(s.formula) || re.test(s.formula);
    });

    const groupLabel = groupsDict[el.element_group]?.name_singular_ru ?? el.element_group;

    return {
      params: { symbol: el.symbol },
      props: { element: el, elementReactions, relatedSubstances, groupLabel },
    };
  });
}

interface Props {
  element: ElementData;
  elementReactions: ReactionData[];
  relatedSubstances: SubstanceEntry[];
  groupLabel: string;
}

const { element, elementReactions, relatedSubstances, groupLabel } = Astro.props as Props;
const el = element;

const oxStates = el.typical_oxidation_states
  .map(s => (s > 0 ? `+${s}` : String(s)))
  .join(', ');

const hasPhysical = el.melting_point_C != null || el.boiling_point_C != null || el.density_g_cm3 != null;
const hasDiscovery = el.discovery && (el.discovery.year || el.discovery.scientist_ru);
const hasHazards = el.hazards_ru && el.hazards_ru.length > 0;
const hasFacts = el.fun_facts_ru && el.fun_facts_ru.length > 0;
---

<BaseLayout
  title={`${el.name_ru} (${el.symbol}) — element #${el.Z}`}
  description={`${el.name_ru} (${el.symbol}, Z=${el.Z}) — properties, electron configuration, applications.`}
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "ChemicalSubstance",
      "name": el.name_en,
      "alternateName": el.name_ru,
      "description": `${el.name_en} — chemical element #${el.Z}`,
      "inLanguage": "en",
    })} />
  </Fragment>

  <article class="element-page container">
    <div class="element-page__header">
      <div class="element-page__z">{el.Z}</div>
      <h1 class="element-page__symbol">{el.symbol}</h1>
      <div class="element-page__name">{el.name_ru}</div>
      <div class="element-page__latin">{el.name_latin}</div>
    </div>

    <dl class="element-page__props">
      <dt>Атомная масса</dt>
      <dd>{el.atomic_mass}</dd>

      <dt>Группа / Период</dt>
      <dd>{el.group} / {el.period}</dd>

      <dt>Тип</dt>
      <dd>{groupLabel}</dd>

      {oxStates && (
        <>
          <dt>Степени окисления</dt>
          <dd>{oxStates}</dd>
        </>
      )}

      {el.electronegativity != null && (
        <>
          <dt>Электроотрицательность</dt>
          <dd>{el.electronegativity} (Полинг)</dd>
        </>
      )}
    </dl>

    {el.electron_exception && (
      <section class="element-page__section element-page__exception">
        <h2>Провал электрона</h2>
        <div class="element-page__exception-compare">
          <span>Ожидаемая: <s>{el.electron_exception.expected_formula}</s></span>
          <span>Реальная: <b>{el.electron_exception.actual_formula}</b></span>
        </div>
        <p class="element-page__text">{el.electron_exception.reason_ru}</p>
      </section>
    )}

    {hasPhysical && (
      <section class="element-page__section">
        <h2>Физические свойства</h2>
        <dl class="element-page__props">
          {el.melting_point_C != null && (
            <>
              <dt>Температура плавления</dt>
              <dd>{el.melting_point_C} °C</dd>
            </>
          )}
          {el.boiling_point_C != null && (
            <>
              <dt>Температура кипения</dt>
              <dd>{el.boiling_point_C} °C</dd>
            </>
          )}
          {el.density_g_cm3 != null && (
            <>
              <dt>Плотность</dt>
              <dd>{el.density_g_cm3} г/см³</dd>
            </>
          )}
        </dl>
      </section>
    )}

    {hasDiscovery && (
      <section class="element-page__section">
        <h2>Открытие</h2>
        <div class="element-page__discovery">
          {el.discovery!.year && <span class="element-page__discovery-year">{el.discovery!.year} г.</span>}
          {el.discovery!.scientist_ru && <span>{el.discovery!.scientist_ru}</span>}
          {el.discovery!.country_ru && <span class="element-page__discovery-country">({el.discovery!.country_ru})</span>}
        </div>
      </section>
    )}

    {el.abundance_ru && (
      <section class="element-page__section">
        <h2>Распространённость</h2>
        <p class="element-page__text">{el.abundance_ru}</p>
      </section>
    )}

    {el.industrial_ru && (
      <section class="element-page__section">
        <h2>Применение</h2>
        <p class="element-page__text">{el.industrial_ru}</p>
      </section>
    )}

    {el.production_ru && (
      <section class="element-page__section">
        <h2>Получение</h2>
        <p class="element-page__text">{el.production_ru}</p>
      </section>
    )}

    {hasHazards && (
      <section class="element-page__section">
        <h2>Опасность и хранение</h2>
        <div class="element-page__hazards">
          {el.hazards_ru!.map(h => (
            <span class="element-page__hazard-tag">{h}</span>
          ))}
        </div>
        {el.storage_ru && <p class="element-page__text element-page__storage">{el.storage_ru}</p>}
      </section>
    )}

    {elementReactions.length > 0 && (
      <section class="element-page__section">
        <h2>Реакции</h2>
        <ul class="element-page__reactions">
          {elementReactions.map(r => (
            <li>
              <a href={`/en/reactions/#${r.reaction_id}`}>{r.equation}</a>
              <span class="element-page__reaction-title">{r.title}</span>
            </li>
          ))}
        </ul>
      </section>
    )}

    {relatedSubstances.length > 0 && (
      <section class="element-page__section">
        <h2>Вещества</h2>
        <div class="element-page__substances">
          {relatedSubstances.map(s => (
            <a href={`/en/substances/${s.id}/`} class="element-page__substance-link">
              {s.formula}{s.name_ru ? ` (${s.name_ru})` : ''}
            </a>
          ))}
        </div>
      </section>
    )}

    {hasFacts && (
      <section class="element-page__section">
        <h2>Интересные факты</h2>
        <ul class="element-page__facts">
          {el.fun_facts_ru!.map(f => (
            <li>{f}</li>
          ))}
        </ul>
      </section>
    )}

    <div class="element-page__actions">
      <a href="/en/periodic-table/">&larr; Периодическая таблица</a>
    </div>
  </article>
</BaseLayout>

<style>
  .element-page {
    max-width: 640px;
    padding: var(--space-xl) var(--space-md);
  }

  .element-page__header {
    text-align: center;
    margin-bottom: var(--space-xl);
    padding: var(--space-lg);
    background: var(--color-bg-alt);
    border-radius: 0.75rem;
    border: 1px solid var(--color-border);
  }
  .element-page__z {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    font-weight: 600;
  }
  .element-page__symbol {
    font-size: 3rem;
    margin: 0;
    line-height: 1.1;
  }
  .element-page__name {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: var(--space-xs);
  }
  .element-page__latin {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    font-style: italic;
  }

  .element-page__props {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--space-sm) var(--space-lg);
    margin-bottom: var(--space-lg);
    align-items: baseline;
  }
  .element-page__props dt {
    font-weight: 600;
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }
  .element-page__props dd {
    margin: 0;
    font-size: 0.9375rem;
  }

  .element-page__section {
    margin-bottom: var(--space-xl);
  }
  .element-page__section h2 {
    font-size: 1.125rem;
    font-weight: 700;
    margin: 0 0 var(--space-sm);
    padding-bottom: var(--space-xs);
    border-bottom: 2px solid var(--color-border);
  }

  .element-page__text {
    font-size: 0.9375rem;
    line-height: 1.6;
    margin: 0;
    color: var(--color-text);
  }

  .element-page__exception {
    padding: var(--space-md);
    background: #fffbeb;
    border: 1px solid #fde68a;
    border-radius: 0.5rem;
  }
  .element-page__exception-compare {
    display: flex;
    gap: var(--space-lg);
    font-size: 0.9375rem;
    font-family: var(--font-mono);
    margin-bottom: var(--space-sm);
    flex-wrap: wrap;
  }

  .element-page__discovery {
    display: flex;
    gap: var(--space-sm);
    align-items: baseline;
    font-size: 0.9375rem;
    flex-wrap: wrap;
  }
  .element-page__discovery-year {
    font-weight: 700;
    color: var(--color-primary);
  }
  .element-page__discovery-country {
    color: var(--color-text-muted);
  }

  .element-page__hazards {
    display: flex;
    gap: var(--space-xs);
    flex-wrap: wrap;
    margin-bottom: var(--space-sm);
  }
  .element-page__hazard-tag {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    font-size: 0.8125rem;
    background: #fef2f2;
    color: #991b1b;
    border: 1px solid #fecaca;
    border-radius: 0.25rem;
    font-weight: 500;
  }
  .element-page__storage {
    margin-top: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--color-bg-alt);
    border-left: 3px solid #f59e0b;
    border-radius: 0.25rem;
    font-size: 0.875rem;
  }

  .element-page__reactions {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .element-page__reactions li {
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }
  .element-page__reactions li:last-child {
    border-bottom: none;
  }
  .element-page__reactions a {
    font-family: var(--font-mono);
    font-size: 0.875rem;
  }
  .element-page__reaction-title {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
  }

  .element-page__substances {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }
  .element-page__substance-link {
    display: inline-block;
    padding: 0.25rem 0.625rem;
    border: 1px solid var(--color-border);
    border-radius: 0.375rem;
    font-size: 0.8125rem;
    color: var(--color-text);
    transition: border-color 0.15s;
  }
  .element-page__substance-link:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
    text-decoration: none;
  }

  .element-page__facts {
    margin: 0;
    padding-left: var(--space-lg);
  }
  .element-page__facts li {
    font-size: 0.9375rem;
    line-height: 1.6;
    margin-bottom: var(--space-xs);
  }

  .element-page__actions {
    margin-top: var(--space-xl);
    padding-top: var(--space-md);
    border-top: 1px solid var(--color-border);
  }
</style>
